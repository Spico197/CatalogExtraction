# ç¯‡ç« æ–‡æ¡£æ ‘æ„å»ºä»£ç ä½¿ç”¨è¯´æ˜

## æ¨¡å‹è®­ç»ƒ

1. æ£€æŸ¥ `examples/doc_tree_construction/train` ä¸­çš„ `config.yaml` é…ç½®æ–‡ä»¶ï¼Œåˆ†åˆ«é…ç½®å¦‚ä¸‹é¡¹ç›®ï¼š

```yaml
# å¿…å¡«ï¼šä¼šæ ¹æ®ä»»åŠ¡åç§°åˆ›å»ºä»»åŠ¡æ–‡ä»¶å¤¹
name: transducer
# å¿…å¡«ï¼šæ•°æ®æ–‡ä»¶å¤¹ä½ç½®ï¼Œå»ºè®®ä½¿ç”¨ç»å¯¹è·¯å¾„
data_dir: /data4/tzhu/DocTree/data/doc_tree_construct/mix_all
# å¿…å¡«ï¼šé¢„è®­ç»ƒæ¨¡å‹æ‰€åœ¨ä½ç½®ï¼Œå¯å¡«å†™æ¨¡å‹æ–‡ä»¶å¤¹ä½ç½®ä½¿ç”¨æœ¬åœ°é¢„åŠ è½½æ¨¡å¼ï¼Œæˆ–å¡«å†™ç¼©å†™ä½¿ç”¨åœ¨çº¿ä¸‹è½½æ¨¡å¼
plm_dir: hfl/rbt3
# å¿…å¡«ï¼šå¸Œæœ›åœ¨å“ªä¸ªæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä»»åŠ¡æ–‡ä»¶å¤¹
output_dir: /data4/tzhu/DocTree/outputs
# å¿…å¡«ï¼šè®¾ç½®è®­ç»ƒæ¨¡å¼ï¼Œ`skip_train` è¡¨ç¤ºè·³è¿‡è®­ç»ƒè¿‡ç¨‹ï¼Œ`skip_further_train` è¡¨ç¤ºè·³è¿‡ç»§ç»­è®­ç»ƒçš„è¿‡ç¨‹ï¼ˆé€šå¸¸ç”¨åœ¨æ•°æ®è¿ç§»ä¸­ï¼Œfurther trainç”¨æ¥åœ¨ç›®æ ‡é¢†åŸŸè¿›è¡Œç»§ç»­è®­ç»ƒï¼‰
skip_train: false
skip_further_train: true
# å¿…å¡«ï¼šè®¾ç½®è®¾å¤‡å·
device: cuda:0
# å¿…å¡«ï¼šå–æ¶ˆdebugæ¨¡å¼ï¼ˆdebugæ¨¡å¼ä¼šé»˜è®¤åªåŠ è½½å°‘é‡æ•°æ®ï¼‰
debug_mode: false
```

2. ä¸Šè¿°é…ç½®æ£€æŸ¥å®Œæ¯•ä¹‹åï¼Œä¿®æ”¹shellæ–‡ä»¶( `examples/doc_tree_construction/train/run.sh` )ä¸­çš„é…ç½®æ–‡ä»¶è·¯å¾„ã€‚

3. å¼€å§‹è®­ç»ƒ

```bash
$ bash examples/doc_tree_construction/train/run.sh
```

## æ¨¡å‹æ¨ç†

æ¨¡å‹çš„æ¨ç†å’Œä½¿ç”¨å¯å‚è€ƒ `examples/doc_tree_construction/inference/run.py` ä¸­çš„ä½¿ç”¨æ–¹å¼ã€‚åªéœ€åœ¨ä»£ç ä¸­æŒ‰å¦‚ä¸‹æ–¹å¼è°ƒç”¨å³å¯ï¼š

```python
# å¯¼å…¥ä»»åŠ¡ç±»
from doctree.tasks.transducer_task import TransducerDocTreeConstructionTask

# å¯¼å…¥é…ç½®æ–‡ä»¶å’Œæ¨¡å‹
task = TransducerDocTreeConstructionTask.from_taskdir(
    "æ‰€åœ¨ä»»åŠ¡çš„æ–‡ä»¶å¤¹ï¼Œå¯¹åº”è®­ç»ƒé…ç½®æ–‡ä»¶ä¸­çš„ output_dir/name",
    load_best_model=True,       # å¯¼å…¥æ¨¡å‹
    load_best_optimizer=False,  # ä¸å¯¼å…¥ä¼˜åŒ–å™¨å‚æ•°
    load_train_data=False,      # ä¸å¯¼å…¥è®­ç»ƒæ•°æ®
    load_dev_data=False,        # ä¸å¯¼å…¥å¼€å‘æ•°æ®
    load_test_data=False,       # ä¸å¯¼å…¥æµ‹è¯•æ•°æ®
    initialize=True,            # è®¾ç½®éšæœºç§å­å’Œlogæ–‡ä»¶ä½ç½®
    makedirs=False,             # ä¸åˆ›å»ºæ–°çš„ä»»åŠ¡æ–‡ä»¶å¤¹
    dump_configfile=False,      # ä¸ä¿å­˜é…ç½®æ–‡ä»¶
)
text_data = [
    "æ–‡æœ¬1",
    "æ–‡æœ¬2",
    "æ–‡æœ¬3"
]

# è¿›è¡Œé¢„æµ‹ï¼Œè¾“å…¥ä¸º List[str]ï¼Œè¾“å‡ºä¸º `Node` ç±»ï¼Œå…³äº `Node` ç±»çš„å®šä¹‰åŠæ–¹æ³•ï¼Œå¯è§ `doctree/data/definition.py` ä¸­çš„å†…å®¹
# ä¸€ä¸ª `Node` åŒ…å«ï¼š
#   guidï¼šæ–‡æ¡£æ ‘ç»“æ„idï¼Œè¡¨ç¤ºèŠ‚ç‚¹åœ¨æ–‡æ¡£ä¸­çš„ä½ç½®
#   labelï¼šèŠ‚ç‚¹ç±»å‹ï¼ŒåŒ…æ‹¬ Root, Heading å’Œ Text
#   contentï¼šå½“å‰èŠ‚ç‚¹çš„æ–‡æœ¬
#   childrenï¼šå½“å‰èŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹
pred_node = task.predict(text_data)
# ä¸‹é¢å±•ç¤ºå‡ ä¸ªæ¥å£
# å°†é¢„æµ‹ç»“æœè½¬æ¢ä¸º `dict`
pred_dict = pred_node.traverse()
# å°†dictç»“æ„æ‹å¹³
from doctree.data.convert import line_reorder
node_list = line_reorder(pred_dict)
```

## ğŸ’¾ æ•°æ®æ ¼å¼

å½“æœ‰æ–°æ•°æ®æ—¶ï¼Œéœ€è¦å°†æ–°æ•°æ®è½¬æ¢ä¸ºå½“å‰ä»£ç å¯æ”¯æŒçš„æ•°æ®è¾“å…¥æ ¼å¼ã€‚
å¯ä»¥æ£€æŸ¥ `tests/data/test_definition.py` ä¸­ `test_traverse()` æµ‹è¯•æ ·ä¾‹ä»¥åŠ `tests/data/test_convert.py` ä¸­ `test_parse_with_prefix_and_suffix()` çš„æµ‹è¯•æ ·ä¾‹ã€‚
å½“å‰ç³»ç»Ÿæ”¯æŒçš„æ•°æ®æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š

```python
{
    "guid": "0",
    "label": NodeType.Root,
    "content": ["ROOT"],
    "children": [
        {
            "guid": "0.0",
            "label": NodeType.Heading,
            "content": ["Main Title", "--Second Line Title"],
            "children": [
                {
                    "guid": "0.0.0",
                    "label": NodeType.Heading,
                    "content": ["Heading 1"],
                    "children": [
                        {
                            "guid": "0.0.0.0",
                            "label": NodeType.Text,
                            "content": ["Text1"],
                            "children": [],
                        },
                        {
                            "guid": "0.0.0.1",
                            "label": NodeType.Text,
                            "content": ["Text2"],
                            "children": [],
                        },
                        {
                            "guid": "0.0.0.2",
                            "label": NodeType.Heading,
                            "content": ["Heading 1.1"],
                            "children": [
                                {
                                    "guid": "0.0.0.2.0",
                                    "label": NodeType.Text,
                                    "content": ["Text 3"],
                                    "children": [],
                                }
                            ],
                        },
                        {
                            "guid": "0.0.0.3",
                            "label": NodeType.Text,
                            "content": ["Text4"],
                            "children": [],
                        },
                        {
                            "guid": "0.0.0.4",
                            "label": NodeType.Text,
                            "content": ["Text5"],
                            "children": [],
                        },
                        {
                            "guid": "0.0.0.5",
                            "label": NodeType.Heading,
                            "content": ["Heading 1.2"],
                            "children": [
                                {
                                    "guid": "0.0.0.5.0",
                                    "label": NodeType.Text,
                                    "content": ["Text 6"],
                                    "children": [],
                                },
                                {
                                    "guid": "0.0.0.5.1",
                                    "label": NodeType.Text,
                                    "content": ["Text 7"],
                                    "children": [],
                                },
                            ],
                        },
                        {
                            "guid": "0.0.0.6",
                            "label": NodeType.Text,
                            "content": ["Text8"],
                            "children": [],
                        },
                        {
                            "guid": "0.0.0.7",
                            "label": NodeType.Text,
                            "content": ["Text9"],
                            "children": [],
                        },
                    ],
                },
                {
                    "guid": "0.0.1",
                    "label": NodeType.Heading,
                    "content": ["Heading 2"],
                    "children": [
                        {
                            "guid": "0.0.1.0",
                            "label": NodeType.Text,
                            "content": ["Text10"],
                            "children": [],
                        },
                        {
                            "guid": "0.0.1.1",
                            "label": NodeType.Text,
                            "content": ["Text11"],
                            "children": [],
                        },
                    ],
                },
            ],
        }
    ],
}
```

æˆ‘ä»¬æä¾›äº†æ•°æ®è½¬æ¢è„šæœ¬ï¼Œä»¥ä¸‹æ˜¯å¤§è‡´çš„è½¬æ¢æµç¨‹ï¼š

1. æ ‡æ³¨äººå‘˜ä½¿ç”¨wordå·¥å…·è¿›è¡Œæ•°æ®æ ‡æ³¨ï¼ŒæŠŠæ ‡é¢˜æ–‡æœ¬æŒ‰æ ‡é¢˜æ ·å¼ï¼ˆä¸»è¦æ˜¯è¦ç¬¦åˆå¤§çº²ç»“æ„ï¼Œå¯ä½¿ç”¨wordçš„å¯¼èˆªçª—æ ¼ä¾§æ æŸ¥çœ‹æ•°æ®æ ‡æ³¨çš„å±‚çº§ï¼‰å¦‚æœæœ‰å’Œæ ‡é¢˜åŒçº§çš„æ–‡æœ¬ï¼Œåˆ™å¯åŠ å…¥ç‰¹æ®Šå‰ç¼€æˆ–åç¼€è¿›è¡ŒåŒºåˆ†ã€‚è¿™é‡Œæˆ‘ä»¬æ¼”ç¤ºä»¥æœ«å°¾å¥å·è¿›è¡Œæ ‡é¢˜åŒçº§æ–‡æœ¬çš„è½¬æ¢è¿‡ç¨‹ã€‚å…·ä½“çš„æ ‡æ³¨è¿‡ç¨‹å¦‚ä¸‹:
    1. åœ¨æ­£æ–‡ä¸­åˆ é™¤æ‰€æœ‰çš„å¤§æ ‡é¢˜ï¼Œå¹¶é¢å¤–è®°å½•ï¼›
    2. å¦‚æœç‰‡æ®µè¢«é”™è¯¯åˆ‡åˆ†ï¼Œåˆ™åˆå¹¶ï¼›
    3. åˆ é™¤ç›®å½•å’Œæ‰€æœ‰è¡¨æ ¼ï¼›
    4. å¦‚æœæŸä¸€æ®µæ–‡æœ¬æ»¡è¶³æ ‡é¢˜å®šä¹‰ï¼Œåˆ™æŒ‰å¤§çº²ç»“æ„è¿›è¡Œæ ‡æ³¨ï¼Œå°†å…¶è°ƒæ•´ä¸ºå¯¹åº”çº§åˆ«çš„æ ‡é¢˜æ ·å¼ï¼Œå¦‚æœæœ«å°¾æœ‰æ ‡ç‚¹ç¬¦å·ï¼Œåˆ™åˆ é™¤æ ‡ç‚¹ï¼›
    5. å¦‚æœæŸä¸€æ–‡æœ¬ç‰‡æ®µå’Œæ ‡é¢˜åŒçº§ï¼Œä½†å¤„äºæ ‡é¢˜é åçš„ä½ç½®ï¼Œåˆ™åœ¨å…¶æ–‡å°¾æ·»åŠ æ ‡è¯†ç¬¦â€œã€‚â€å¹¶æ ‡æ³¨ä¸ºæ ‡é¢˜ã€‚

2. wordå·¥å…·æ ‡æ³¨å®Œä¹‹åï¼Œä½¿ç”¨[pandoc](https://pandoc.org/)å·¥å…·æˆ–è€…ä½¿ç”¨wordè‡ªå¸¦çš„å¯¼å‡ºåŠŸèƒ½ï¼Œå°†docxæ ¼å¼æ–‡ä»¶è½¬æ¢ä¸ºhtml
3. å‚è€ƒ `tests/data/test_convert.py` ä¸­çš„æµ‹è¯•æ ·ä¾‹ï¼Œå°†htmlæ–‡ä»¶è½¬æ¢ä¸ºjsonæ–‡ä»¶æ ¼å¼ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```python
from doctree.data.convert import convert_html_string_with_xfix

title = "ç¯‡ç« å¤§æ ‡é¢˜"

html_string = """
<p>Text before heading 1</p>
<h1>Heading 1</h1>
    <p>Text after heading 1</p>
    <h2>Text1ã€‚</h2>
    <h2>Text2ã€‚</h2>
    <h2>Heading 1.1</h2>
        <p>Text 3</p>
    <h2>Text4ã€‚</h2>
    <h2>Text5ã€‚</h2>
    <h2>Heading 1.2</h2>
        <p>Text 6</p>
        <p>Text 7</p>
    <h2>Text8ã€‚</h2>
    <h2>Text9ã€‚</h2>
<h1>Heading 2</h1>
    <h2>Text10ã€‚</h2>
    <h2>Text11ã€‚</h2>
"""

# å¾—åˆ°ä¸€ä¸ª `Node` å®ä¾‹
root_node = convert_html_string_with_xfix(
    html_string,
    title,
    suffix='ã€‚'
)
# è½¬æ¢ä¸º dict
doc_dict = root_node.traverse()
# è½¬æ¢ä¸ºjsonå­—ç¬¦ä¸²
import json
json_string = json.dumps(doc_dict, ensure_ascii=False)
```
